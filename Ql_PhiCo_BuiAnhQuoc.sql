CREATE DATABASE QLPhiCo_BuiAnhQuoc
GO
USE QLPhiCo_BuiAnhQuoc
GO

-- A. TẠO CƠ SỞ DỮ LIỆU
-- 1. Tạo được cấu trúc bảng, mối quan hệ giữa các bảng
CREATE TABLE PHICO (
    MAPC CHAR(5) NOT NULL,
    TENPHICO NVARCHAR(100),
    KHOANGCACHBAY INT,
)
ALTER TABLE PHICO ADD CONSTRAINT pk_phico PRIMARY KEY(MAPC)

CREATE TABLE NHANVIEN (
    MANV CHAR(7) NOT NULL,
    HOTENNV NVARCHAR(100),
    NGAYSINH DATE,
    DIACHI NVARCHAR(100),
    LUONGCB INT
)
ALTER TABLE NHANVIEN ADD CONSTRAINT pk_nhanvien PRIMARY KEY(MANV)

CREATE TABLE CHUYENBAY (
    MACB CHAR(9) NOT NULL,
    MAPC CHAR(5),
    NoiXP VARCHAR(100),
    NoiDen VARCHAR(100),
    GioXP DATETIME,
    GioDen DATETIME
)
ALTER TABLE CHUYENBAY ADD CONSTRAINT pk_chuyenbay PRIMARY KEY(MACB)
ALTER TABLE CHUYENBAY ADD CONSTRAINT fk_chuyenbay_phico FOREIGN KEY(MAPC) REFERENCES PHICO(MAPC)

CREATE TABLE CHITIET_CHUYENBAY (
    MACB CHAR(9) NOT NULL,
    MANV CHAR(7) NOT NULL,
)
ALTER TABLE CHITIET_CHUYENBAY ADD CONSTRAINT pk_chitietchuyenbay PRIMARY KEY(MACB, MANV)
ALTER TABLE CHITIET_CHUYENBAY ADD CONSTRAINT fk_chitietchuyenbay_chuyenbay FOREIGN KEY (MACB) REFERENCES CHUYENBAY(MACB)
ALTER TABLE CHITIET_CHUYENBAY ADD CONSTRAINT fk_chitietchuyenbay_nhanvien FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

-- 2. Nhập dữ liệu của các bảng, mỗi bảng ít nhất nhất 1 bản ghi
INSERT INTO PHICO VALUES
('BL750', 'Airbus B320', 5000),
('QH228', 'Airbus B321', 1660),
('VJ144', 'Airbus C322', 2300),
('VN216', 'Airbus D323', 7000),
('VN238', 'Airbus D324', 5700),
('BL850', 'Airbus A320', 3500),
('QH350', 'Airbus A321', 4000)

INSERT INTO NHANVIEN VALUES
('MPC.001', N'Đào Duy Thịnh', '1985-05-15', N'30, Võ Nguyên Giáp', 50000),
('MPC.002', N'Phạm Thanh Bình', '1985-05-13', N'17, Trần Nguyên Hãn', 70000),
('MPC.003', N'Nguyễn Thành Duy', '1904-05-12', N'253, Nguyễn Thái Học', 50000),
('MPC.004', N'Bùi Trọng Trung', '1981-05-10', N'32, Nguyễn Công Trứ', 70000),
('MPC.005', N'Nguyễn Đức Dũng', '1987-05-30', N'17, Hồ Xuân Hương', 70000),
('MTV.001', N'Nguyễn Hà Nam', '1989-05-10', N'78, Định Công', 45000),
('MTV.002', N'Nguyễn Duy Chung', '1980-10-28', N'34, Mỹ Đình', 45000),
('MTV.003', N'Nguyễn Đình Thủy', '1980-04-27', N'178, Láng Hạ', 35000),
('MTV.004', N'Đinh Thế Dũng', '1991-06-07', N'Gia Lâm', 35000),
('MTV.005', N'Ngô Tuấn Dũng', '1981-05-02', N'Hồ Hoàn Kiếm', 35000)

INSERT INTO CHUYENBAY VALUES
('CBND.0001', 'VJ144', 'HANOI', 'TPHCM', '2019-10-24 07:00:00', '2019-10-24 10:00:00'),
('CBND.0002', 'QH228', 'HANOI', 'VINH', '2019-10-25 08:00:00', '2019-10-25 09:00:00'),
('CBND.0003', 'BL750', 'HANOI', 'DANANG', '2019-11-24 09:00:00', '2019-11-24 11:00:00'),
('CBND.0004', 'QH228', 'VINH', 'TPHCM', '2019-11-26 10:00:00', '2019-11-26 14:00:00'),
('CBND.0005', 'QH350', 'DANANG', 'VINH', '2019-11-20 11:00:00', '2019-11-20 12:00:00'),
('CBQT.0001', 'VN216', 'HANOI', 'TOKYO', '2020-01-24 07:00:00', '2020-01-24 13:00:00'),
('CBQT.0002', 'VN238', 'TOKYO', 'TPHCM', '2020-02-25 07:00:00', '2020-02-25 12:00:00')

INSERT INTO CHITIET_CHUYENBAY VALUES
('CBND.0001', 'MPC.001'),
('CBND.0001', 'MTV.001'),
('CBND.0003', 'MPC.005'),
('CBND.0003', 'MTV.001'),
('CBQT.0001', 'MPC.004'),
('CBQT.0002', 'MTV.001')

-- B. THỰC HIỆN CÁC TRUY VẤN
-- 1. Đưa ra danh sách các phi cơ (MAPC, TENPHICO, KHOANGCACHBAY) có khoảng cách bay từ 1000km đến 5000km, đã bay vào năm 2020
SELECT MAPC, TENPHICO, KHOANGCACHBAY FROM PHICO
WHERE KHOANGCACHBAY >= 1000 AND KHOANGCACHBAY <= 5000 AND MAPC IN (SELECT MAPC FROM CHUYENBAY WHERE YEAR(GioXP) = 2020)

-- 2. Đưa ra danh sách các chuyến bay (MACB, NoiXP, NoiDen, GioXP, GioDen, TENPHICO, số lượng nhân viên) khởi hành từ Hà Nội bay trong năm 2019
SELECT CHUYENBAY.MACB, NoiXP, NoiDen, GioXP, GioDen, TENPHICO, SONHANVIEN FROM
    CHUYENBAY
    INNER JOIN (SELECT MACB, COUNT(MANV) AS SONHANVIEN FROM CHITIET_CHUYENBAY GROUP BY MACB) AS CTCB ON CHUYENBAY.MACB = CTCB.MACB
    INNER JOIN PHICO ON CHUYENBAY.MAPC = PHICO.MAPC
WHERE NoiXP = 'HANOI' AND YEAR(GioXP) = 2019

-- 3. Đưa ra thông tin nhân viên (MANV, HOTEN, DIACHI) và số lần tham gia bay, tổng lương trong 6 tháng đầu năm 2020.
SELECT NHANVIEN.MANV, HOTENNV, DIACHI, SOLANBAY, (SOLANBAY * LUONGCB) AS TONGLUONG FROM
    NHANVIEN
    INNER JOIN (
        SELECT MANV, COUNT(MACB) AS SOLANBAY FROM CHITIET_CHUYENBAY
        WHERE MACB IN (SELECT MACB FROM CHUYENBAY WHERE YEAR(GioXP) = 2020 AND MONTH(GioXP) <= 6)
        GROUP BY MANV
    ) AS CHITIET_CHUYENBAY1 ON NHANVIEN.MANV = CHITIET_CHUYENBAY1.MANV

-- 4. Đưa ra danh sách các phi cơ (MAPC, TENPHICO) có số lần bay nhiều nhất năm 2019
SELECT CHUYENBAY.MAPC, TENPHICO FROM
    CHUYENBAY
    INNER JOIN PHICO ON CHUYENBAY.MAPC = PHICO.MAPC
WHERE YEAR(GioXP) = 2019
GROUP BY CHUYENBAY.MAPC, TENPHICO
HAVING COUNT(MACB) >= ALL(
    SELECT COUNT(MACB) FROM CHUYENBAY
    WHERE YEAR(GioXP) = 2019
    GROUP BY MAPC
)

-- 5. Đưa ra danh sách nhân viên tham gia tất cả các chuyến bay từ năm 2015 đến năm 2020
SELECT MANV, HOTENNV, NGAYSINH FROM NHANVIEN
WHERE MANV IN (
    SELECT MANV FROM CHITIET_CHUYENBAY
    WHERE MACB IN (SELECT MACB FROM CHUYENBAY WHERE YEAR(GioXP) >= 2015 AND YEAR(GioXP) <= 2020)
    GROUP BY MANV
    HAVING COUNT(MACB) = (SELECT COUNT(MACB) FROM CHUYENBAY WHERE YEAR(GioXP) >= 2015 AND YEAR(GioXP) <= 2020)
)

-- 6. Đưa ra danh sách các phi cơ chưa thực hiện chuyến bay nào trong năm 2012
SELECT * FROM PHICO
WHERE MAPC NOT IN (
    SELECT MAPC FROM CHUYENBAY
    WHERE YEAR(GioXP) = 2012
)

-- 7. Đưa ra các chuyến bay (MACB, NoiXP, NoiDen) có thời gian bay <= 6 tiếng
SELECT * FROM CHUYENBAY
WHERE DATEDIFF(SECOND, GioXP, GioDen) <= 6 * 3600