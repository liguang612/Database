-- A. TẠO LẬP CƠ SỞ DỮ LIỆU NHƯ ĐỀ BÀI.

-- a.1. Tạo được cấu trúc của bảng, đưa ra được quan hệ (Diagram) giữa các bảng.
CREATE DATABASE QL_Duan_PhamAnhTuan
GO
USE QL_Duan_PhamAnhTuan
GO

CREATE TABLE DUAN (
    MADUAN CHAR(6) NOT NULL,
    TENDUAN NVARCHAR(1000) NOT NULL,
    KINHPHI BIGINT NOT NULL,
    TGBD DATE,
    TGKT DATE,
)
ALTER TABLE DUAN ADD CONSTRAINT pk_duan PRIMARY KEY(MADUAN)

CREATE TABLE CHUCVU (
    MACHUCVU VARCHAR(5) NOT NULL,
    TENCHUCVU NVARCHAR(100) NOT NULL,
    LUONGCB INT,
)
ALTER TABLE CHUCVU ADD CONSTRAINT pk_chucvu PRIMARY KEY(MACHUCVU)

CREATE TABLE NHANVIEN (
    MANV CHAR(7) NOT NULL,
    HOTTENNV NVARCHAR(100),
    NGAYSINH DATE,
    GIOITINH VARCHAR(3),
    MACHUCVU VARCHAR(5) NOT NULL,
)
ALTER TABLE NHANVIEN ADD CONSTRAINT pk_nhanvien PRIMARY KEY(MANV)
ALTER TABLE NHANVIEN ADD CONSTRAINT fk_nhanvien_chucvu FOREIGN KEY(MACHUCVU) REFERENCES CHUCVU(MACHUCVU)

CREATE TABLE PHANCONG (
    MADUAN CHAR(6) NOT NULL,
    MANV CHAR(7) NOT NULL,
    SONGAYCONG INT NOT NULL,
)
ALTER TABLE PHANCONG ADD CONSTRAINT pk_phancong PRIMARY KEY(MADUAN, MANV)
ALTER TABLE PHANCONG ADD CONSTRAINT fk_phancong_duan FOREIGN KEY(MADUAN) REFERENCES DUAN(MADUAN)
ALTER TABLE PHANCONG ADD CONSTRAINT fk_phancong_nhanvien FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

-- a.2. Nhập liệu vào bảng
INSERT INTO DUAN VALUES
    ('CB.001', N'Quốc lộ 1A - Ninh Bình', 50000, '2015-01-01', '2018-01-01'),
    ('CB.002', N'Quốc lọ 1A - Nghệ An', 75000, '2015-10-05', '2018-10-05'),
    ('CB.003', N'Quốc lộ 1A - Hà Tĩnh', 56000, '2016-12-12', '2019-12-12'),
    ('CT.001', N'Thông tin CSVC', 2300, '2018-12-12', '2019-12-12'),
    ('CT.002', N'Tông tin phòng thí nghiệm', 4300, '2017-01-01', '2018-01-01'),
    ('CT.003', N'Thông tin khoa học', 5400, '2018-01-05', '2019-01-05'),
    ('NN.001', N'Cao tốc Hải Phòng', 45000, '2017-05-05', '2019-05-05'),
    ('NN.002', N'Cao tốc Pháp Vân', 55000, '2018-10-09', '2019-10-05'),
    ('DN.001', N'Trạm thu phí cầu Giẽ', 42000, '2017-01-12', '2019-01-12'),
    ('DN.002', N'Đèo Hải Vân', 17000, '2018-01-12', '2020-01-12')

INSERT INTO CHUCVU VALUES
    ('CN', N'Chủ nhiệm', 70),
    ('TVC', N'Thành viên chính', 550),
    ('TV', N'Thành viên', 450),
    ('KTV', N'Kỹ thuật viên', 300)


INSERT INTO NHANVIEN VALUES
    ('GV.0001', N'Lưu Thành Long', '1985-01-10', N'Nam', 'TV'),
    ('GV.0002', N'Lê Thanh Tuấn', '1984-05-15', N'Nam', 'TV'),
    ('GC.0001', N'Nguyễn Văn Nam', '1978-02-15', N'Nam', 'CN'),
    ('GC.0002', N'Nguyễn Lan Hương', '1988-07-18', N'Nữ', 'CN'),
    ('GV.0003', N'Đinh Thu Hằng', '1988-10-19', N'Nữ', 'TV'),
    ('KT.0001', N'Trần Nam Anh', '1979-10-16', N'Nam', 'KTV'),
    ('KT.0002', N'Lê Văn Đồng', '1989-10-20', N'Nam', 'KTV'),
    ('GV.0004', N'Vũ Hòng Hạnh', '1988-10-16' ,N'Nữ', 'TVC'),
    ('GC.0003', N'Lê Thanh Tùng', '1982-10-23', N'Nam', 'TVC')

INSERT INTO PHANCONG VALUES
    ('CB.001', 'GC.0001', 120),
    ('CB.001', 'GV.0001', 150),
    ('CB.001', 'GV.0004', 200),
    ('CB.001', 'GV.0002', 200),
    ('CB.001', 'KT.0001', 150),
    ('CT.001', 'GC.0002', 130),
    ('CT.001', 'GV.0004', 130),
    ('CT.001', 'GV.0002', 180),
    ('CT.001', 'GV.0003', 150),
    ('CT.001', 'KT.0001', 200),
    ('CT.001', 'KT.0002', 230),
    ('NN.002', 'GC.0001', 200),
    ('NN.002', 'GC.0003', 250),
    ('NN.001', 'GC.0002', 150),
    ('NN.001', 'GV.0004', 200),
    ('NN.001', 'GV.0003', 300)

-- B. THỰC HIỆN CÁC YÊU CẦU TRUY VẤN

-- 1. Đưa ra danh sách các dự án (MADUAN, TENDUAN, TGBD, TGKT) có kính phí từ 5000 đến 50000
SELECT MADUAN, TENDUAN, TGBD, TGKT FROM DUAN WHERE KINHPHI >= 5000 AND KINHPHI <= 50000

-- 2. Đưa ra thông tin nhân viên (MANV, HOTENNV), số dự án thực hiện, tổng ngày công thực hiện, tổng tiền công được nhận
SELECT NHANVIEN.MANV, HOTTENNV, SODUAN, TONGNGAYCONG, TONGNGAYCONG * LUONGCB AS TONGTIEN FROM NHANVIEN
    INNER JOIN CHUCVU ON NHANVIEN.MACHUCVU = CHUCVU.MACHUCVU
    INNER JOIN (SELECT MANV, COUNT(MADUAN) AS SODUAN, SUM(SONGAYCONG) AS TONGNGAYCONG FROM PHANCONG GROUP BY MANV) AS PHANCONG1 ON NHANVIEN.MANV = PHANCONG1.MANV

-- 3. Đưa ra danh sách các nhân viên (MANV, HOTENNV, TENCHUCVU), tổng số ngày công, luong mà có tổng lương thực hiện các dự án từ năm 2017 đến năm 2020 là lớn nhất
SELECT NHANVIEN.MANV, HOTTENNV, TENCHUCVU, TONGSONGAYCONG, TONGSONGAYCONG * LUONGCB AS LUONG
FROM NHANVIEN
    INNER JOIN CHUCVU ON NHANVIEN.MACHUCVU = CHUCVU.MACHUCVU
    INNER JOIN (SELECT MANV, SUM(SONGAYCONG) AS TONGSONGAYCONG FROM PHANCONG
                WHERE MADUAN IN (SELECT MADUAN FROM DUAN WHERE YEAR(TGBD) >= 2017 AND YEAR(TGBD) <= 2020)
                GROUP BY MANV) AS TABLE1 ON NHANVIEN.MANV = TABLE1.MANV
WHERE TONGSONGAYCONG * LUONGCB IN (SELECT TOP 1 TONGSONGAYCONG * LUONGCB AS LUONG FROM NHANVIEN
    INNER JOIN CHUCVU ON NHANVIEN.MACHUCVU = CHUCVU.MACHUCVU
    INNER JOIN (SELECT MANV, SUM(SONGAYCONG) AS TONGSONGAYCONG FROM PHANCONG
                WHERE MADUAN IN (SELECT MADUAN FROM DUAN WHERE YEAR(TGBD) >= 2017 AND YEAR(TGBD) <= 2020)
                GROUP BY MANV) AS TABLE1 ON NHANVIEN.MANV = TABLE1.MANV
ORDER BY LUONG)

-- 4. Đưa ra danh sách các dự án có thời gian thực hiện nhiều nhất năm 2020
SELECT MADUAN, TENDUAN, KINHPHI, DATEDIFF(DAY, TGBD, TGKT) AS SONGAYTHUCHIEN FROM DUAN
WHERE YEAR(TGBD) = 2020
GROUP BY MADUAN, TENDUAN, KINHPHI, TGBD, TGKT
HAVING DATEDIFF(DAY, TGBD, TGKT) >= ALL(
    SELECT DATEDIFF(DAY, TGBD, TGKT) AS SONGAYTHUCHIEN FROM DUAN
    WHERE YEAR(TGBD) = 2020
    GROUP BY MADUAN, TGBD, TGKT
)

-- 5. Đưa ra danh sách các nhân viên tham gia tất cả các dự án trong năm 2012 (TGBD = 2012 hoặc TGKT = 2012)
SELECT * FROM NHANVIEN
WHERE MANV IN (
    SELECT MANV FROM PHANCONG
    WHERE MADUAN IN (SELECT MADUAN FROM DUAN WHERE YEAR(TGBD) = 2012 OR YEAR(TGKT) = 2012)
    GROUP BY MANV
    HAVING COUNT(MADUAN) = (SELECT COUNT(MADUAN) FROM DUAN WHERE YEAR(TGBD) = 2012 OR YEAR(TGKT) = 2012)
)

-- 6. Đưa ra danh sách các dự án có kinh phí thực hiện >= 4000 mà có số nhân viên tham gia đông nhất
SELECT DUAN.MADUAN, TENDUAN, KINHPHI, TGBD, TGKT FROM PHANCONG
    INNER JOIN DUAN ON PHANCONG.MADUAN = DUAN.MADUAN
WHERE KINHPHI >= 4000
GROUP BY DUAN.MADUAN, TENDUAN, KINHPHI, TGBD, TGKT 
HAVING COUNT(MANV) >= ALL(
    SELECT COUNT(MANV) FROM PHANCONG
        INNER JOIN DUAN ON PHANCONG.MADUAN = DUAN.MADUAN
    WHERE KINHPHI >= 4000
    GROUP BY PHANCONG.MADUAN
)

-- 7. Đưa ra dự án có số lượng nhân viên trẻ (<= 20 tuổi) nhiều nhất
SELECT PHANCONG.MADUAN, TENDUAN, KINHPHI, TGBD, TGKT, COUNT(MANV) AS SOLUONGNHANVIEN FROM PHANCONG
    INNER JOIN DUAN ON DUAN.MADUAN = PHANCONG.MADUAN
WHERE MANV IN (SELECT MANV FROM NHANVIEN WHERE YEAR(GETDATE()) - YEAR(NGAYSINH) <= 20)
GROUP BY PHANCONG.MADUAN, TENDUAN, KINHPHI, TGBD, TGKT
HAVING COUNT(MANV) >= ALL (
    SELECT COUNT(MANV) FROM PHANCONG
        INNER JOIN DUAN ON DUAN.MADUAN = PHANCONG.MADUAN
    WHERE MANV IN (SELECT MANV FROM NHANVIEN WHERE YEAR(GETDATE()) - YEAR(NGAYSINH) <= 20)
    GROUP BY PHANCONG.MADUAN
)

-- b.4. Đưa ra danh sách các nhân viên chưa tham gia dự án nào trong năm 2022
SELECT *
FROM NHANVIEN
WHERE MANV NOT IN (SELECT MANV FROM PHANCONG INNER JOIN DUAN ON PHANCONG.MADUAN = DUAN.MADUAN WHERE YEAR(TGBD) = 2022 OR YEAR(TGKT) = 2022)

-- b.5. Đưa ra danh sách các dự án có kinh phí đầu tư lớn hơn 500.000.000 VND
SELECT MADUAN, TENDUAN, TGBD, TGKT
FROM DUAN
WHERE KINHPHI >= 500000000

-- b.6. Đưa ra danh sách nhân viên trẻ (dưới 30 tuổi) có số dự án tham gia ít hơn hoặc bằng 2 dự án
SELECT NHANVIEN.MANV, HOTTENNV, GIOITINH, (CASE WHEN SODUAN IS NULL THEN 0 ELSE SODUAN END) AS SODUAN
FROM NHANVIEN
    LEFT JOIN (SELECT MANV, COUNT(MADUAN) AS SODUAN FROM PHANCONG GROUP BY MANV HAVING COUNT(MADUAN) <= 2) AS TABLE1 ON NHANVIEN.MANV = TABLE1.MANV
WHERE YEAR(GETDATE()) - YEAR(NGAYSINH) < 30

-- b.7. Viết trigger kiểm tra ngày sinh nhập vào phải có năm sinh trước năm 2001
GO
CREATE TRIGGER trigger_ngaysinh ON NHANVIEN
AFTER INSERT AS
BEGIN
    IF EXISTS (SELECT 1 FROM inserted WHERE YEAR(inserted.NGAYSINH) > 2001)
    BEGIN
        RAISERROR(N'Năm sinh phải trước năm 2001', 16, 1)
        ROLLBACK TRANSACTION;
    END;
END;

DROP DATABASE QL_Duan_PhamAnhTuan