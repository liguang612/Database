CREATE DATABASE _20211_De01_BuiAnhQuoc
USE _20211_De01_BuiAnhQuoc
GO

-- 1. Tạo cở dữ liệu quản lý chuyến bay
CREATE TABLE NHANVIEN (
    MANV CHAR(6) NOT NULL,
    HOTEN NVARCHAR(100),
    NHIEMVU NVARCHAR(20),
    LUONGGIO INT,
)
ALTER TABLE NHANVIEN ADD CONSTRAINT pk_nhanvien PRIMARY KEY(MANV)

CREATE TABLE MAYBAY (
    MAMB CHAR(5) NOT NULL,
    TENMB NVARCHAR(100),
    SOKHACH INT,
)
ALTER TABLE MAYBAY ADD CONSTRAINT pk_maybay PRIMARY KEY(MAMB)

CREATE TABLE CHUYENBAY (
    MACB CHAR(6) NOT NULL,
    MAMB CHAR(5),
    NOIXP NVARCHAR(100),
    NOIDEN NVARCHAR(100),
    SOKHACH INT,
    NGAYBAY DATE,
    SOGIOBAY FLOAT,
)
ALTER TABLE CHUYENBAY ADD CONSTRAINT pk_chuyenbay PRIMARY KEY(MACB)
ALTER TABLE CHUYENBAY ADD CONSTRAINT fk_chuyenbay_maybay FOREIGN KEY(MAMB) REFERENCES MAYBAY(MAMB)

CREATE TABLE CHITIETCHUYENBAY (
    MACB CHAR(6) NOT NULL,
    MANV CHAR(6) NOT NULL,
)
ALTER TABLE CHITIETCHUYENBAY ADD CONSTRAINT pk_chitietchuyenbay PRIMARY KEY(MACB, MANV)
ALTER TABLE CHITIETCHUYENBAY ADD CONSTRAINT fk_chitietchuyenbay_chuyenbay FOREIGN KEY(MACB) REFERENCES CHUYENBAY(MACB)
ALTER TABLE CHITIETCHUYENBAY ADD CONSTRAINT fk_chitietchuyenbay_nhanvien FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

-- 2. Hãy thực hiện các ràng buộc tòan vẹn sau
-- 2.1. Chuyến bay: Nơi xuất phát phải khác nơi đến
ALTER TABLE CHUYENBAY ADD CONSTRAINT check_noixp_noiden CHECK(LOWER(NOIDEN) <> LOWER(NOIXP))

-- 2.2. Máy bay: số khách tôi đa của máy bay >= 350
ALTER TABLE MAYBAY ADD CONSTRAINT check_sokhach CHECK(SOKHACH >= 350)

-- 2.3. Nhân viên: Nhiệm vụ là: cơ trưởng, phó cơ trưởng, tiếp viên, lương theo giờ >= 100
ALTER TABLE NHANVIEN ADD CONSTRAINT check_nhiemvu CHECK (NHIEMVU IN (N'Cơ trưởng', N'Phó cơ trưởng', N'Tiếp viên') AND LUONGGIO >= 100)

-- 3. Nhập dữ liệu vào các bảng
INSERT INTO NHANVIEN VALUES
('NV0001', N'Hoàng Long', N'Cơ trưởng', 150),
('NV0002', N'Trần Nam Anh', N'Phó cơ trưởng', 125),
('NV0003', N'LÊ TIẾN ĐẠT', N'Tiếp viên', 100),
('NV0004', N'Nguyễn Bình AN', N'Cơ trưởng', 150),
('NV0005', N'Đinh văn Minh', N'Phó cơ trưởng', 125),
('NV0006', N'Ngô Lệ Bình', N'Tiếp viên', 100),
('NV0007', N'Vũ Tuấn Anh', N'Tiếp viên', 100)
INSERT INTO MAYBAY VALUES
('BL750', 'Airbus A320', 450),
('QH228', 'Airbus A321', 350),
('VJ144', 'Boing A320', 450),
('VJ146', 'Boing 146', 540),
('VN216', 'Airbus A350', 500),
('VN238', 'Boing A321', 450)
INSERT INTO CHUYENBAY VALUES
('CB0001', 'BL750', N'TP HCM', N'HÀ NỘI', 340, '2021-10-10', 5.5),
('CB0002', 'QH228', N'Hà Nội', N'NHA TRANG', 300, '2021-12-10', 4.5),
('CB0003', 'VJ144', N'TP HCM', N'ĐÀ NẴNG', 400, '2021-11-10', 2),
('CB0004', 'VN216', N'Hà Nội', N'Đà Nẵng', 350, '2021-10-15', 3.5),
('CB0005', 'VN238', N'TP HCM', N'Hà Nội', 350, '2021-10-20', 5.5)
INSERT INTO CHITIETCHUYENBAY VALUES
('CB0001', 'NV0001'),
('CB0001', 'NV0002'),
('CB0001', 'NV0003'),
('CB0001', 'NV0006'),
('CB0002', 'NV0004'),
('CB0002', 'NV0005'),
('CB0002', 'NV0006'),
('CB0002', 'NV0007'),
('CB0003', 'NV0001'),
('CB0003', 'NV0002'),
('CB0003', 'NV0003'),
('CB0003', 'NV0007'),
('CB0004', 'NV0001'),
('CB0004', 'NV0002'),
('CB0004', 'NV0006'),
('CB0004', 'NV0007'),
('CB0005', 'NV0002'),
('CB0005', 'NV0003'),
('CB0005', 'NV0004'),
('CB0005', 'NV0005'),
('CB0005', 'NV0006')

-- 4. Viết các câu lệnh SQL thực hiện các truy vấn sau
-- 4.1. Đưa ra mã nhân viên, tên nhân viên, nhiệm vụ, số chuyến bay, tổng số khách của những Cơ trưởng, điều hành máy bay có tên “Airbus...” có ngày bay trong tháng 10/2021.
SELECT TABLE1.MANV, HOTEN, NHIEMVU, COUNT(TABLE1.MACB) AS SOCHUYENBAY, SUM(SOKHACH) AS TONGSOKHACH FROM
    (SELECT * FROM CHITIETCHUYENBAY
    WHERE MACB IN (SELECT MACB FROM CHUYENBAY WHERE (NGAYBAY >= '2021-10-01' AND NGAYBAY <= '2021-10-31') AND MAMB IN (SELECT MAMB FROM MAYBAY WHERE TENMB LIKE N'Airbus%')) 
          AND MANV IN (SELECT MANV FROM NHANVIEN WHERE NHIEMVU LIKE N'Cơ trưởng')) AS TABLE1
    INNER JOIN NHANVIEN ON TABLE1.MANV = NHANVIEN.MANV
    INNER JOIN CHUYENBAY ON TABLE1.MACB = CHUYENBAY.MACB
GROUP BY TABLE1.MANV, NHANVIEN.HOTEN, NHANVIEN.NHIEMVU

-- 4.2. Đưa ra máy bay có số tiền công cho nhân viên nhiều nhất với các thông tin: Mã máy bay, Tên máy bay, số khách chuẩn, tổng số nhân viên bay, số khách thực tế, Tiền công của máy bay trong tháng 10,11/2021. trong đó tiền công của máy bay bằng tổng tiền của các công nhân viên bay (Tiền công của nhân viên = số giờ bay * Lương theo giờ).
SELECT MAYBAY.MAMB, MAYBAY.TENMB, SUM(MAYBAY.SOKHACH) AS SOKHACHCHUAN, COUNT(NHANVIEN.MANV) AS TONGSONHANVIEN, SUM(CHUYENBAY1.SOKHACH) AS SOKHACHTHUCTE, SUM(NHANVIEN.LUONGGIO * CHUYENBAY1.SOGIOBAY) AS TONGLUONG FROM
    CHITIETCHUYENBAY
    INNER JOIN (SELECT * FROM CHUYENBAY WHERE NGAYBAY >= '2021-10-01' AND NGAYBAY <= '2021-11-30') AS CHUYENBAY1 ON CHITIETCHUYENBAY.MACB = CHUYENBAY1.MACB
    INNER JOIN MAYBAY ON CHUYENBAY1.MAMB = MAYBAY.MAMB
    INNER JOIN NHANVIEN ON CHITIETCHUYENBAY.MANV = NHANVIEN.MANV
GROUP BY MAYBAY.MAMB, MAYBAY.TENMB
HAVING SUM(NHANVIEN.LUONGGIO * CHUYENBAY1.SOGIOBAY) >= ALL(
    SELECT SUM(NHANVIEN.LUONGGIO * CHUYENBAY1.SOGIOBAY) AS TONGLUONG FROM
        CHITIETCHUYENBAY
        INNER JOIN (SELECT * FROM CHUYENBAY WHERE NGAYBAY >= '2021-10-01' AND NGAYBAY <= '2021-11-30') AS CHUYENBAY1 ON CHITIETCHUYENBAY.MACB = CHUYENBAY1.MACB
        INNER JOIN MAYBAY ON CHUYENBAY1.MAMB = MAYBAY.MAMB
        INNER JOIN NHANVIEN ON CHITIETCHUYENBAY.MANV = NHANVIEN.MANV
    GROUP BY MAYBAY.MAMB, MAYBAY.TENMB
)

-- 4.3. Đưa ra danh sách nhân viên có số chuyến bay >=3 với các thông tin: Mã nhân viên, họ tên nhân viên, số chuyến bay, tổng số giờ bay, tổng tiền công trong năm 2021.
SELECT CHITIETCHUYENBAY.MANV, HOTEN, COUNT(CHITIETCHUYENBAY.MACB) AS SOCHUYENBAY, SUM(SOGIOBAY) AS TONGSOGIOBAY, SUM(SOGIOBAY * LUONGGIO) AS TONGLUONG FROM
    CHITIETCHUYENBAY
    INNER JOIN CHUYENBAY ON CHITIETCHUYENBAY.MACB = CHUYENBAY.MACB
    INNER JOIN NHANVIEN ON CHITIETCHUYENBAY.MANV = NHANVIEN.MANV
GROUP BY CHITIETCHUYENBAY.MANV, HOTEN
HAVING COUNT(CHITIETCHUYENBAY.MACB) >= 3

-- 5. Tạo Store procedure với các yêu cầu sau.
-- 5.1. Thao tác select các máy bay có tên “Airbus...”
GO
CREATE PROCEDURE p1 AS
BEGIN
    SELECT * FROM MAYBAY WHERE TENMB LIKE N'Airbus%';
END;

-- 5.2. Thao tác insert bảng máy bay với các dữ liệu như sau: (Mã MB: VN123, Tên MB: Vins 1236, số khách: 450)
GO
CREATE PROCEDURE p2 AS
BEGIN
    INSERT INTO MAYBAY VALUES ('VN123', N'Vins 1236', 450);
END;

-- 5.3. Thao tác select thông tin về Máy bay có tên “Airbus....” Với các thông tin danh sách phi hành đoàn ( mã nhân viên, họ tên, nhiệm vụ, số giờ bay, tiền công).
GO
CREATE PROCEDURE p3 AS
BEGIN
    SELECT MAYBAY1.MAMB, TENMB, CHITIETCHUYENBAY.MANV, NHANVIEN.HOTEN, NHANVIEN.NHIEMVU, SUM(SOGIOBAY) AS TONGSOGIOBAY, SUM(SOGIOBAY * LUONGGIO) AS TIENCONG FROM
        (SELECT MAMB, TENMB FROM MAYBAY WHERE TENMB LIKE N'Airbus%') AS MAYBAY1
        INNER JOIN CHUYENBAY ON MAYBAY1.MAMB = CHUYENBAY.MAMB
        INNER JOIN CHITIETCHUYENBAY ON CHUYENBAY.MACB = CHITIETCHUYENBAY.MACB
        INNER JOIN NHANVIEN ON CHITIETCHUYENBAY.MANV = NHANVIEN.MANV
    GROUP BY MAYBAY1.MAMB, TENMB, CHITIETCHUYENBAY.MANV, NHANVIEN.HOTEN, NHANVIEN.NHIEMVU;
END;