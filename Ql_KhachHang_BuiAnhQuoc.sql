CREATE DATABASE QL_KhachHang_BuiAnhQuoc
GO

-- A. TẠO CƠ SỞ DỮ LIỆU VÀ CÁC BẢNG
USE QL_KhachHang_BuiAnhQuoc
GO

-- 1. Tạo cấu trúc bảng, đưa ra được các quan hệ.
CREATE TABLE KHACHHANG (
    MAKH CHAR(7) NOT NULL,
    HOTEN NVARCHAR(50),
    DCHI NVARCHAR(100),
    SDT CHAR(10),
    NGSINH DATE
)
ALTER TABLE KHACHHANG ADD CONSTRAINT pk_khachhang PRIMARY KEY(MAKH)

CREATE TABLE SANPHAM (
    MASP VARCHAR(50) NOT NULL,
    TENSP NVARCHAR(100),
    DVT NVARCHAR(20),
    NUOCSX NVARCHAR(50),
    DONGIA INT
)
ALTER TABLE SANPHAM ADD CONSTRAINT pk_sanpham PRIMARY KEY(MASP)

CREATE TABLE HOADON (
    SOHD INT NOT NULL,
    NGAYHD DATE,
    MAKH CHAR(7),
)
ALTER TABLE HOADON ADD CONSTRAINT pk_hoadon PRIMARY KEY(SOHD)
ALTER TABLE HOADON ADD CONSTRAINT fk_hoadon_khachhang FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH)

CREATE TABLE CTHOADON (
    SOHD INT NOT NULL,
    MASP VARCHAR(50) NOT NULL,
    SL INT
)
ALTER TABLE CTHOADON ADD CONSTRAINT pk_cthoadon PRIMARY KEY(SOHD, MASP)
ALTER TABLE CTHOADON ADD CONSTRAINT fk_cthoadon_hoadon FOREIGN KEY(SOHD) REFERENCES HOADON(SOHD)
ALTER TABLE CTHOADON ADD CONSTRAINT fk_cthoadon_sanpham FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)

-- 2. Nhập dữ liệu vào bảng, mỗi brang ít nhất 3 bản ghi
INSERT INTO KHACHHANG VALUES
('HDG.001', N'Đào Duy Thịnh', N'Võ Nguyên Giáp', '0915962468', '1984-11-13'),
('HDG.002', N'Phạm Thanh Bình', N'Trần Nguyên Hãn', '0944639886', '1986-01-27'),
('HDG.003', N'Nguyễn Thành Duy', N'Nguyễn Thái Học', '0913277115', '1991-03-31'),
('HDG.004', N'Bùi Trọng Trung', N'Nguyễn Công Trứ', '0946647737', '1987-11-21'),
('HDG.005', N'Nguyễn Đức Dũng', N'Hồ Xuân Hương', '0916916995', '1989-05-09'),
('HNI.001', N'Nguyễn Thu Hà', N'Định Công', '0169696645', '1980-10-15'),
('HNI.002', N'Nguyễn Duy Chung', N'Mỹ Đình', '0914361566', '1980-10-28'),
('HNI.003', N'Nguyễn Thị Phương Thu', N'Láng Hạ', '0915111115', '1981-11-27'),
('HNI.004', N'Đinh Thế Dũng', N'Gia Lâm', '0243993939', '1991-04-04')

INSERT INTO SANPHAM VALUES
('RUS.BINHNUOC', N'Bình nước', N'Chiếc', N'NGA', 80),
('RUS.BINHHOA', N'Bình hoa', N'Chiếc', N'NGA', 150),
('USA.MOCKHOA', N'Móc khóa', N'Chiếc', N'MỸ', 75),
('USA.REMOTE', N'Điều khiển từ xa', N'Chiếc', N'MỸ', 125000),
('VNM.MOCTREO', N'Móc treo', N'Chiếc', N'VIỆT NAM', 15000),
('VNM.KHOACUA', N'Khóa cửa', N'Chiếc', N'VIỆT NAM', 75000),
('CAM.KHANRAN', N'Khăn rằn', N'Chiếc', N'CAMPUCHIA', 65000),
('MAS.MUBAOHIEM', N'Mũ bảo hiểm', N'Chiếc', N'MALAYSIA', 180000),
('MAS.AOBAOHIEM', N'Áo bảo hiểm', N'Chiếc', N'MALAYSIA', 350000)

INSERT INTO HOADON VALUES
(81357, '2017-05-18', 'HDG.001'),
(81359, '2017-05-19', 'HNI.002'),
(81361, '2017-05-21', 'HDG.001'),
(81363, '2017-05-26', 'HDG.004'),
(81365, '2017-06-18', 'HDG.005'),
(81366, '2017-06-19', 'HNI.001'),
(81369, '2017-06-21', 'HNI.002'),
(81371, '2017-06-29', 'HDG.003'),
(81373, '2017-07-18', 'HNI.004')

INSERT INTO CTHOADON VALUES
(81357, 'RUS.BINHNUOC', 5),
(81359, 'RUS.BINHHOA', 1),
(81361, 'USA.MOCKHOA', 2),
(81363, 'USA.REMOTE', 3),
(81365, 'VNM.MOCTREO', 10),
(81366, 'VNM.KHOACUA', 1),
(81369, 'CAM.KHANRAN', 5),
(81371, 'MAS.MUBAOHIEM', 1),
(81373, 'MAS.AOBAOHIEM', 2)

-- B. THỰC HIỆN CÁC YÊU CẦU TRUY VẤN
-- 1. Hiển thị thông tin khách hàng (MAKH, HOTEN, DCHI, SDT) đã mua 3 sản phẩm trong tháng 12 năm 2017
SELECT MAKH, HOTEN, DCHI, SDT FROM KHACHHANG
WHERE MAKH IN (
    SELECT MAKH FROM
        (SELECT SOHD, MAKH FROM HOADON WHERE YEAR(NGAYHD) = 2017 AND MONTH(NGAYHD) = 12) AS TABLE1
        INNER JOIN (SELECT SOHD FROM CTHOADON GROUP BY SOHD HAVING SUM(SL) = 3) AS TABLE2 ON TABLE1.SOHD = TABLE2.SOHD
)

-- 2. Đưa ra thông tin hóa đơn (SOHD, NGAYHD, HOTEN, DCHI, Tổng tiền) của các hóa đơn có khách hàng trẻ (dưới 20 tuổi)
SELECT HOADON.SOHD, NGAYHD, HOTEN, DCHI, TONGTIEN FROM 
    HOADON
    INNER JOIN KHACHHANG ON HOADON.MAKH = KHACHHANG.MAKH AND DATEDIFF(YEAR, NGSINH, GETDATE()) < 20
    INNER JOIN (
        SELECT SOHD, SUM(SL * DONGIA) AS TONGTIEN FROM
            CTHOADON
            INNER JOIN SANPHAM ON CTHOADON.MASP = SANPHAM.MASP
        GROUP BY SOHD
    ) AS TABLE1 ON HOADON.SOHD = TABLE1.SOHD

-- 3. Đưa ra các mặt hàng (MASP, TENSP, DONGIA, NUOCSX) bán nhiều nhất trong năm 2019
SELECT CTHOADON.MASP, TENSP, DONGIA, NUOCSX FROM CTHOADON
    INNER JOIN SANPHAM ON CTHOADON.MASP = SANPHAM.MASP
WHERE SOHD IN (SELECT SOHD FROM HOADON WHERE YEAR(NGAYHD) = 2019)
GROUP BY CTHOADON.MASP, SANPHAM.TENSP, SANPHAM.DONGIA, SANPHAM.NUOCSX
HAVING SUM(SL) >= ALL(
    SELECT SUM(SL) FROM CTHOADON
        INNER JOIN SANPHAM ON CTHOADON.MASP = SANPHAM.MASP
    WHERE SOHD IN (SELECT SOHD FROM HOADON WHERE YEAR(NGAYHD) = 2019)
    GROUP BY CTHOADON.MASP
)

-- 4. Đưa ra danh sách khách hàng mua từ 2 sản phẩm "Mũ bảo hiểm" trở lên tại cửa hàng
SELECT * FROM KHACHHANG
WHERE MAKH IN (
    SELECT MAKH FROM
        HOADON
        INNER JOIN CTHOADON ON HOADON.SOHD = CTHOADON.SOHD
    WHERE MASP IN (SELECT MASP FROM SANPHAM WHERE TENSP LIKE N'Mũ bảo hiểm')
    GROUP BY MAKH
    HAVING SUM(SL) >= 2
)

-- 5. Đưa ra thông tin các khách hàng (MAKKH, HOTEN, DCHI ,SDT) đã mua tất cả các sản phẩm xuất xứ từ Việt Nam.
SELECT MAKH, HOTEN, DCHI, SDT FROM KHACHHANG
WHERE MAKH IN (
    SELECT MAKH FROM
        HOADON
        INNER JOIN CTHOADON ON HOADON.SOHD = CTHOADON.SOHD
    WHERE MASP IN (SELECT MASP FROM SANPHAM WHERE NUOCSX LIKE N'VIỆT NAM')
    GROUP BY MAKH
    HAVING COUNT(DISTINCT MASP) = (
        SELECT COUNT(MASP) FROM SANPHAM WHERE NUOCSX LIKE N'VIỆT NAM' GROUP BY NUOCSX
    )
)

-- 6. Đưa ra thông tin các sản phẩm (MASP, TENSP, NUOCSX, DONGIA) đã không bán được trong năm 2017 nhưng bán được trong năm 2018
SELECT MASP, TENSP, NUOCSX, DONGIA FROM SANPHAM
WHERE MASP NOT IN (
    SELECT MASP FROM CTHOADON
    WHERE SOHD IN (SELECT SOHD FROM HOADON WHERE YEAR(NGAYHD) = 2017)
)
INTERSECT
SELECT MASP, TENSP, NUOCSX, DONGIA FROM SANPHAM
WHERE MASP IN (
    SELECT MASP FROM CTHOADON
    WHERE SOHD IN (SELECT SOHD FROM HOADON WHERE YEAR(NGAYHD) = 2018)
)

-- 7. Đưa ra thông tin khách hàng (MAKH, HOTEN, DCHI) và số lần mua, tổng tiền hóa đơn mua trong năm 2017, với tổng tiền hóa đơn lớn hơn 10000000 VND và tổng lần mua lớn hơn 4
SELECT HOADON1.MAKH, HOTEN, DCHI, COUNT(HOADON1.SOHD) AS SOLANMUA, SUM(TONGTIEN) AS TONGTIEN FROM
    (SELECT * FROM HOADON WHERE YEAR(NGAYHD) = 2017) AS HOADON1
    INNER JOIN (
        SELECT CTHOADON.SOHD, SUM(SL * DONGIA) AS TONGTIEN FROM
            CTHOADON
            INNER JOIN SANPHAM ON CTHOADON.MASP = SANPHAM.MASP
        GROUP BY CTHOADON.SOHD
    ) AS CTHOADON1 ON HOADON1.SOHD = CTHOADON1.SOHD
    INNER JOIN KHACHHANG ON HOADON1.MAKH = KHACHHANG.MAKH
GROUP BY HOADON1.MAKH, HOTEN, DCHI
HAVING COUNT(HOADON1.SOHD) > 4 AND SUM(TONGTIEN) > 10000000